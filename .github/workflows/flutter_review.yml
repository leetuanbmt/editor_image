name: Flutter Review Workflow

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  analyze_and_test:
    name: Ph√¢n t√≠ch v√† ki·ªÉm th·ª≠
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: C√†i ƒë·∫∑t Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.27.1"
          channel: "stable"
          cache: true
          architecture: x64

      - name: C√†i ƒë·∫∑t dependencies
        run: flutter pub get

      - name: Flutter generate models
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Flutter generate locale
        run: flutter pub run bin/generate.dart

      # Ki·ªÉm tra 2.1 v√† 2.2: Code compiles without warnings, Static analysis
      - name: Ph√¢n t√≠ch code
        run: flutter analyze

      # Ki·ªÉm tra 2.4: No spelling mistakes
      - name: Ki·ªÉm tra l·ªói ch√≠nh t·∫£
        run: |
          echo "Checking for common spelling mistakes..."
          grep -r -i "\b\(recieve\|lenght\|heigth\|widht\|paramater\|cancle\|retreive\|occured\)\b" --include="*.dart" lib/ || true
          # Th√¥ng b√°o nh∆∞ng kh√¥ng l·ªói n·∫øu t√¨m th·∫•y

      # Ki·ªÉm tra 3.1-3.4: Naming conventions
      - name: Ki·ªÉm tra quy t·∫Øc ƒë·∫∑t t√™n
        run: |
          echo "Checking class naming conventions (3.1)..."
          # T√¨m c√°c l·ªõp kh√¥ng tu√¢n theo UpperCamelCase
          grep -r "class [a-z]" --include="*.dart" lib/ && echo "Classes should use UpperCamelCase" || echo "Class naming OK"

          echo "Checking variable naming conventions (3.3)..."
          # T√¨m c√°c bi·∫øn kh√¥ng tu√¢n theo lowerCamelCase (kh√≥ ki·ªÉm tra t·ª± ƒë·ªông ho√†n to√†n)
          grep -r "final [A-Z]" --include="*.dart" lib/ && echo "Variables should use lowerCamelCase" || echo "Variable naming OK"

      # Ki·ªÉm tra 4.5: No commented-out code
      - name: Ki·ªÉm tra commented-out code
        run: |
          echo "Checking for commented-out code..."
          commented_code=$(grep -r "//.*\(return\|if\|}\|{\|for\|while\)" --include="*.dart" lib/ | wc -l)
          echo "Potential commented-out code lines: $commented_code"

      # Ki·ªÉm tra 4.9: No prints in code
      - name: Ki·ªÉm tra print statements
        run: |
          if grep -r "print(" --include="*.dart" lib/; then
            echo "print() statements found in code"
            exit 1
          fi

      # Ki·ªÉm tra 4.13: Switch cases have default
      - name: Ki·ªÉm tra switch cases
        run: |
          echo "Checking switch cases for default statements..."
          switches=$(grep -r "switch" --include="*.dart" lib/ | wc -l)
          defaults=$(grep -r "default:" --include="*.dart" lib/ | wc -l)
          echo "Number of switch statements: $switches"
          echo "Number of default cases: $defaults"
          if [ $switches -gt $defaults ]; then
            echo "Warning: Not all switch statements have default cases"
          fi

      # Ki·ªÉm tra 4.14: Code fit in screen
      - name: Ki·ªÉm tra ƒë·ªô d√†i d√≤ng code
        run: |
          echo "Checking line length (4.14)..."
          long_lines=$(grep -r ".\{100,\}" --include="*.dart" lib/ | wc -l)
          echo "Lines longer than 100 characters: $long_lines"

      # Ki·ªÉm tra 6.1: Package imports
      - name: Ki·ªÉm tra package imports
        run: |
          if grep -r "import '\.\./" --include="*.dart" lib/; then
            echo "Relative imports found, use package imports instead"
            exit 1
          fi

      # Ki·ªÉm tra 6.2: flutter_lints
      - name: Ki·ªÉm tra flutter_lints
        run: |
          if grep -q "flutter_lints" pubspec.yaml; then
            echo "flutter_lints is present in pubspec.yaml"
          else
            echo "flutter_lints is missing in pubspec.yaml"
            exit 1
          fi

      # Ch·∫°y tests
      - name: Ch·∫°y tests
        run: flutter test --coverage

      # Ki·ªÉm tra 4.12: Used const in Widgets
      - name: Ki·ªÉm tra s·ª≠ d·ª•ng const
        run: |
          non_const_widgets=$(grep -r "Widget build" --include="*.dart" lib/ | grep -v "const" | wc -l)
          echo "Non-const widgets found: $non_const_widgets"

      # Ki·ªÉm tra 11.1: Network requests try-catch
      - name: Ki·ªÉm tra try-catch cho network requests
        run: |
          echo "Checking network requests wrapped in try-catch..."
          http_requests=$(grep -r "\.\(get\|post\|put\|delete\|patch\)(.*)" --include="*.dart" lib/ | wc -l)
          try_catch=$(grep -r "try {" --include="*.dart" lib/ | wc -l)
          echo "Potential HTTP requests: $http_requests"
          echo "try-catch blocks: $try_catch"

      # Ki·ªÉm tra 12.1: Dependencies up to date
      - name: Ki·ªÉm tra dependencies
        run: |
          flutter pub outdated

      # Ki·ªÉm tra 12.4: Environment variables
      - name: Ki·ªÉm tra bi·∫øn m√¥i tr∆∞·ªùng
        run: |
          if grep -r "API_KEY=" --include="*.dart" lib/; then
            echo "API keys found in code"
            exit 1
          fi

      # Ph√°t hi·ªán performance issues
      - name: Ki·ªÉm tra v·∫•n ƒë·ªÅ hi·ªáu su·∫•t
        run: |
          # T√¨m ki·∫øm c√°c widget l·ªìng nhau qu√° nhi·ªÅu (7.3: Widgets do not produce render errors)
          deep_nesting=$(grep -r "children:" --include="*.dart" lib/ | wc -l)
          echo "Potential deep nesting issues: $deep_nesting"

          # T√¨m ki·∫øm hardcoded sizes (7.1)
          hardcoded_sizes=$(grep -r "width: [0-9]" --include="*.dart" lib/ | wc -l)
          echo "Hardcoded widget sizes found: $hardcoded_sizes"

          # T√¨m ki·∫øm hardcoded colors (7.2)
          hardcoded_colors=$(grep -r "color: Color(" --include="*.dart" lib/ | wc -l)
          echo "Hardcoded colors found: $hardcoded_colors"

          # T√¨m widgets c√≥ th·ªÉ g√¢y rebuild kh√¥ng c·∫ßn thi·∫øt (8.1-8.3)
          stateful_widgets=$(grep -r "class.*extends StatefulWidget" --include="*.dart" lib/ | wc -l)
          build_context_watch=$(grep -r "context.watch" --include="*.dart" lib/ | wc -l)
          build_context_select=$(grep -r "context.select" --include="*.dart" lib/ | wc -l)
          echo "StatefulWidget count: $stateful_widgets"
          echo "context.watch() usage: $build_context_watch"
          echo "context.select() usage: $build_context_select"

      # L∆∞u k·∫øt qu·∫£ ki·ªÉm tra ƒë·ªÉ b√°o c√°o
      - name: L∆∞u k·∫øt qu·∫£ ki·ªÉm tra
        if: always()
        run: |
          mkdir -p reports
          echo "## K·∫øt qu·∫£ ki·ªÉm tra t·ª± ƒë·ªông" > reports/analysis_results.md
          echo "### T√™n PR: ${{ github.event.pull_request.title }}" >> reports/analysis_results.md
          echo "### Ng∆∞·ªùi t·∫°o PR: ${{ github.event.pull_request.user.login }}" >> reports/analysis_results.md
          echo "### Th·ªùi gian ki·ªÉm tra: $(date)" >> reports/analysis_results.md
          echo "### Link PR: ${{ github.event.pull_request.html_url }}" >> reports/analysis_results.md
          echo "" >> reports/analysis_results.md

          # L·∫•y th√¥ng tin commits
          echo "### Commits:" >> reports/analysis_results.md
          git log --pretty=format:"- %h: %s" -n 5 >> reports/analysis_results.md
          echo "" >> reports/analysis_results.md

          # L·∫•y th√¥ng tin file thay ƒë·ªïi
          echo "### Files thay ƒë·ªïi:" >> reports/analysis_results.md
          git diff --name-only HEAD~1 HEAD >> reports/analysis_results.md
          echo "" >> reports/analysis_results.md

          # T·ªïng h·ª£p k·∫øt qu·∫£ ki·ªÉm tra
          echo "### K·∫øt qu·∫£ ki·ªÉm tra:" >> reports/analysis_results.md

          # Ph√¢n t√≠ch code
          if flutter analyze > /dev/null 2>&1; then
            echo "‚úÖ **Ph√¢n t√≠ch code**: Passed" >> reports/analysis_results.md
          else
            echo "‚ùå **Ph√¢n t√≠ch code**: Failed" >> reports/analysis_results.md
          fi

          # Prints
          if grep -r "print(" --include="*.dart" lib/ > /dev/null 2>&1; then
            echo "‚ùå **Print statements**: Found" >> reports/analysis_results.md
          else
            echo "‚úÖ **Print statements**: Not found" >> reports/analysis_results.md
          fi

          # Package imports
          if grep -r "import '\.\./" --include="*.dart" lib/ > /dev/null 2>&1; then
            echo "‚ùå **Relative imports**: Found" >> reports/analysis_results.md
          else
            echo "‚úÖ **Package imports**: OK" >> reports/analysis_results.md
          fi

          # Hardcoded sizes
          hardcoded_sizes=$(grep -r "width: [0-9]" --include="*.dart" lib/ | wc -l)
          if [ $hardcoded_sizes -gt 0 ]; then
            echo "‚ö†Ô∏è **Hardcoded sizes**: $hardcoded_sizes occurrences" >> reports/analysis_results.md
          else
            echo "‚úÖ **Hardcoded sizes**: None" >> reports/analysis_results.md
          fi

          # Hardcoded colors
          hardcoded_colors=$(grep -r "color: Color(" --include="*.dart" lib/ | wc -l)
          if [ $hardcoded_colors -gt 0 ]; then
            echo "‚ö†Ô∏è **Hardcoded colors**: $hardcoded_colors occurrences" >> reports/analysis_results.md
          else
            echo "‚úÖ **Hardcoded colors**: None" >> reports/analysis_results.md
          fi

          # Const widgets
          non_const_widgets=$(grep -r "Widget build" --include="*.dart" lib/ | grep -v "const" | wc -l)
          if [ $non_const_widgets -gt 0 ]; then
            echo "‚ö†Ô∏è **Non-const widgets**: $non_const_widgets occurrences" >> reports/analysis_results.md
          else
            echo "‚úÖ **Const widgets**: All widgets use const" >> reports/analysis_results.md
          fi

          # Line length
          long_lines=$(grep -r ".\{100,\}" --include="*.dart" lib/ | wc -l)
          if [ $long_lines -gt 0 ]; then
            echo "‚ö†Ô∏è **Long lines**: $long_lines lines longer than 100 characters" >> reports/analysis_results.md
          else
            echo "‚úÖ **Line length**: All lines are within limit" >> reports/analysis_results.md
          fi

          # Tests
          if flutter test --coverage > /dev/null 2>&1; then
            echo "‚úÖ **Tests**: Passed" >> reports/analysis_results.md
          else
            echo "‚ùå **Tests**: Failed" >> reports/analysis_results.md
          fi

          # Link t·ªõi full log
          echo "" >> reports/analysis_results.md
          echo "### [Xem chi ti·∫øt t·∫°i ƒë√¢y](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> reports/analysis_results.md

      - name: Upload analysis report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: analysis-report
          path: reports/analysis_results.md

  manual_review_checklist:
    name: Checklist ki·ªÉm tra th·ªß c√¥ng
    runs-on: ubuntu-latest
    # Kh√¥ng ph·ª• thu·ªôc v√†o job analyze_and_test
    # needs: [analyze_and_test]
    steps:
      - uses: actions/checkout@v3

      - name: Hi·ªÉn th·ªã checklist review
        run: |
          # Hi·ªÉn th·ªã n·ªôi dung c·ªßa .github/pull_request_template.md
          if [ -f ".github/pull_request_template.md" ]; then
            cat .github/pull_request_template.md
          else
            echo "File .github/pull_request_template.md kh√¥ng t√¨m th·∫•y!"
            exit 1
          fi

      # Ch·ªâ upload artifact khi ch·∫°y trong GitHub Actions
      - name: Upload checklist
        if: ${{ github.actions }}
        uses: actions/upload-artifact@v3
        with:
          name: manual-review-checklist
          path: .github/pull_request_template.md

  notify_leader:
    name: Th√¥ng b√°o cho Leader
    runs-on: ubuntu-latest
    needs: [analyze_and_test, manual_review_checklist]
    if: always() && github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v3

      - name: T·∫£i b√°o c√°o ph√¢n t√≠ch
        uses: actions/download-artifact@v3
        with:
          name: analysis-report
          path: reports

      - name: ƒê·ªçc b√°o c√°o ph√¢n t√≠ch
        id: read_report
        run: |
          REPORT_CONTENT=$(cat reports/analysis_results.md)
          # Escape newlines and special characters for GitHub Actions
          REPORT_CONTENT="${REPORT_CONTENT//'%'/'%25'}"
          REPORT_CONTENT="${REPORT_CONTENT//$'\n'/'%0A'}"
          REPORT_CONTENT="${REPORT_CONTENT//$'\r'/'%0D'}"
          echo "::set-output name=content::$REPORT_CONTENT"

      # G·ª≠i th√¥ng b√°o qua Slack
      - name: Th√¥ng b√°o qua Slack
        uses: slackapi/slack-github-action@v1.23.0
        with:
          payload: |
            {
              "text": "K·∫øt qu·∫£ ki·ªÉm tra PR t·ª´ ${{ github.event.pull_request.user.login }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üîç B√°o c√°o ki·ªÉm tra PR"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*PR:* <${{ github.event.pull_request.html_url }}|${{ github.event.pull_request.title }}>\n*Ng∆∞·ªùi t·∫°o:* ${{ github.event.pull_request.user.login }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.read_report.outputs.content }}"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Xem PR"
                      },
                      "url": "${{ github.event.pull_request.html_url }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "Xem Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      # T√πy ch·ªçn: Th√¥ng b√°o qua Microsoft Teams
      # - name: Th√¥ng b√°o qua Microsoft Teams
      #   if: false # B·ªè comment d√≤ng n√†y ƒë·ªÉ k√≠ch ho·∫°t
      #   uses: toko-bifrost/ms-teams-deploy-card@master
      #   with:
      #     webhook-uri: ${{ secrets.MS_TEAMS_WEBHOOK_URI }}
      #     title: "B√°o c√°o ki·ªÉm tra PR"
      #     summary: "PR: ${{ github.event.pull_request.title }}"
      #     text: "${{ steps.read_report.outputs.content }}"
      #     theme-color: "0078D7"
      #     actions: '[{"@type": "OpenUri", "name": "Xem PR", "targets": [{"os": "default", "uri": "${{ github.event.pull_request.html_url }}"}]}, {"@type": "OpenUri", "name": "Xem Workflow", "targets": [{"os": "default", "uri": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}]}]'

      # T√πy ch·ªçn: Th√¥ng b√°o qua Discord
      # - name: Th√¥ng b√°o qua Discord
      #   if: false # B·ªè comment d√≤ng n√†y ƒë·ªÉ k√≠ch ho·∫°t
      #   uses: Ilshidur/action-discord@master
      #   with:
      #     args: 'PR: ${{ github.event.pull_request.title }}\nNg∆∞·ªùi t·∫°o: ${{ github.event.pull_request.user.login }}\n${{ steps.read_report.outputs.content }}'
      #   env:
      #     DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
